name: Generate media.json

on:
  push:
    paths:
      - "media/**"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate media.json
        run: |
          echo "[" > media.json
          first=true
          shopt -s nullglob

          for file in media/*; do
            filename=$(basename "$file")
            ext="${filename##*.}"

            # Build title
            title=$(echo "${filename%.*}" | sed -E 's/[-_]+/ /g')

            # Thumbnail rules
            if [[ "$ext" =~ ^(jpg|jpeg|png|gif|webp)$ ]]; then
              thumbnail="media/$filename"
            else
              thumbnail="https://img.icons8.com/?size=128&id=59833&format=png"
            fi

            # Avoid trailing commas â€” add comma only after the first item
            if [ "$first" = false ]; then
              echo "," >> media.json
            fi
            first=false

            echo "  {\"file\": \"media/$filename\", \"type\": \"$ext\", \"title\": \"$title\", \"thumbnail\": \"$thumbnail\"}" >> media.json

          done

          echo "]" >> media.json

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add media.json
          git commit -m "Update media.json" || echo "No changes"
          git push
